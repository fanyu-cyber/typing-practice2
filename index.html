<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Typing Practice (Zhuyin/Pinyin) - Lesson 2-4 + 自訂打字</title>
  <style>
    :root{
      --bg:#0f172a;
      --panel:#111827;
      --panel2:#0b1220;
      --text:#e5e7eb;
      --muted:#9ca3af;
      --line:#243042;
      --ok:#22c55e;
      --bad:#ef4444;
      --accent:#60a5fa;
      --btn:#1f2937;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:-apple-system,BlinkMacSystemFont,"Helvetica Neue","PingFang TC","Microsoft JhengHei",sans-serif;
      background:var(--bg);
      color:var(--text);
    }
    header{
      padding:18px 18px 10px 18px;
      border-bottom:1px solid var(--line);
    }
    h1{margin:0 0 6px 0; font-size:1.25rem}
    .sub{color:var(--muted); font-size:.95rem}
    main{padding:18px; max-width:1100px; margin:0 auto}

    .grid{
      display:grid;
      grid-template-columns: 380px 1fr;
      gap:14px;
    }
    @media (max-width: 980px){ .grid{grid-template-columns:1fr} }

    .card{
      background:linear-gradient(180deg,var(--panel),var(--panel2));
      border:1px solid var(--line);
      border-radius:14px;
      padding:14px;
      box-shadow:0 8px 22px rgba(0,0,0,.25);
    }

    .titleRow{
      display:flex;
      justify-content:space-between;
      align-items:center;
      flex-wrap:wrap;
      gap:10px;
      margin-bottom:10px;
    }
    .badge{
      font-size:.85rem;
      color:var(--muted);
      border:1px solid var(--line);
      border-radius:999px;
      padding:6px 10px;
      background:rgba(0,0,0,.15);
    }

    .seg{
      display:flex;
      gap:8px;
      width:100%;
      margin-top:6px;
    }
    .seg button{
      flex:1;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--line);
      background:#0b1220;
      color:var(--text);
      cursor:pointer;
      font-weight:800;
    }
    .seg button.active{
      border-color:var(--accent);
      box-shadow:0 0 0 2px rgba(96,165,250,.15);
    }

    .lessonBar{
      display:flex;
      gap:8px;
      margin-top:10px;
      flex-wrap:wrap;
    }
    .lessonBar button{
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--line);
      background:#0b1220;
      color:var(--text);
      cursor:pointer;
      font-weight:800;
      min-width:88px;
    }
    .lessonBar button.active{
      border-color:var(--accent);
      box-shadow:0 0 0 2px rgba(96,165,250,.15);
    }

    .btn{
      background:var(--btn);
      border:1px solid var(--line);
      color:var(--text);
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      font-weight:700;
    }
    .btn.primary{background:#1d4ed8; border-color:#1d4ed8}
    .btn.ghost{background:transparent}
    .btn:hover{border-color:#334155}

    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border:1px solid var(--line);
      border-radius:999px;
      color:var(--muted);
      font-size:.9rem;
      background:rgba(0,0,0,.15);
    }
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}

    .articleBox{
      background:#071022;
      border:1px solid var(--line);
      border-radius:14px;
      padding:14px;
      min-height:240px;
      white-space:pre-wrap;
      line-height:1.9;
      font-size:1.05rem;
    }
    .noSelect{
      -webkit-user-select:none;
      user-select:none;
    }

    .char{padding:0 1px; border-radius:4px}
    .char.ok{color:var(--ok)}
    .char.bad{color:var(--bad)}

    .hint{
      color:var(--muted);
      margin:10px 0 0 0;
      font-size:.92rem;
      line-height:1.5;
    }

    .inputBox{
      width:100%;
      min-height:140px;
      resize:vertical;
      background:#0b1220;
      border:1px solid var(--line);
      border-radius:14px;
      padding:12px;
      color:var(--text);
      font-size:1.05rem;
      line-height:1.7;
      outline:none;
      white-space:pre-wrap;
    }

    .stats{
      margin-top:12px;
      color:var(--muted);
      font-size:.95rem;
      line-height:1.7;
    }
    .stats strong{color:var(--text)}
    .footerTip{
      margin-top:14px;
      padding:12px;
      border:1px dashed #334155;
      border-radius:14px;
      color:#cbd5e1;
      background:rgba(0,0,0,.15);
      display:none;
    }
    .footerTip b{color:#fff}
    .small{font-size:.85rem;color:var(--muted)}
  </style>
</head>

<body>
<header>
  <h1>學生打字練習（注音 / 拼音）</h1>
  <div class="sub">
    Lesson 2–4｜作答頁(1/3/5)：對的不變色、錯字紅｜答案頁(2/4/6)：對綠錯紅 + 顯示正確注音/拼音｜每輪作答都計時
  </div>
</header>

<main>
  <div class="grid">
    <!-- Left -->
    <section class="card">
      <div class="titleRow">
        <div><b>設定</b></div>
        <span class="badge" id="modeBadge">目前：注音</span>
      </div>

      <div>
        <div class="small">1) 先選擇輸入模式 2) 選 Lesson 或自訂 3) 開始</div>
        <div class="seg">
          <button id="btnZhuyin" type="button" class="active">注音</button>
          <button id="btnPinyin" type="button">拼音</button>
        </div>
      </div>

      <div style="margin-top:12px">
        <div class="small">Lesson</div>
        <div class="lessonBar">
          <button id="lesson2" class="active" type="button">Lesson 2</button>
          <button id="lesson3" type="button">Lesson 3</button>
          <button id="lesson4" type="button">Lesson 4</button>
        </div>
      </div>

      <!-- NEW: 打字(自訂內容) -->
      <div style="margin-top:14px; display:flex; gap:10px; flex-wrap:wrap">
        <button class="btn" id="customBtn">打字</button>
        <button class="btn primary" id="startBtn">開始（第 1 次作答）</button>
        <button class="btn" id="resetBtn">重設（回到開始）</button>
      </div>

      <div style="margin-top:14px" class="small">
        防作弊（基礎版）<br/>
        - 題目區禁止選取（減少複製）<br/>
        - 輸入框禁止貼上（Ctrl/Cmd+V 無效）<br/>
        - 自訂「打字」內容框：不可複製 / 不可貼上 / 不可剪下
      </div>
    </section>

    <!-- Right -->
    <section class="card">
      <div class="titleRow">
        <div id="stageName"><b>尚未開始</b></div>
        <div style="display:flex; gap:10px; flex-wrap:wrap">
          <span class="pill">本輪計時：<span id="timer" class="mono">00:00</span></span>
          <span class="pill">全螢幕跳出：<span id="fsCount" class="mono">0</span></span>
        </div>
      </div>

      <div class="articleBox noSelect" id="articleBox">請先選擇「注音 / 拼音」與 Lesson，然後按「開始」。</div>

      <p class="hint" id="hint"></p>

      <textarea class="inputBox" id="inputBox" placeholder="（作答頁才需要輸入）" disabled></textarea>

      <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:12px">
        <button class="btn primary" id="actionBtn" disabled>開始</button>
        <button class="btn ghost" id="fullscreenBtn" style="display:none;">進入全螢幕</button>
      </div>

      <div class="stats" id="stats"></div>

      <div class="footerTip" id="finalTip">
        <b>Please take a screenshot and upload it to Google Classroom.</b>
      </div>
    </section>
  </div>
</main>

<script>
/** =======================
 *  Lessons Text
 *  ======================= */
const LESSON_TEXT = {
  "2": [
    "一般來說，捷運站附近的房子，房租比較貴",
    "你們一起說話，都把我弄糊塗了",
    "在週年慶時買東西東西比較便宜，再說，百貨公司的商品品質比較好。",
    "請幫老師把英文翻譯成中文。",
    "這些菜的做法雖然簡單，但味道並不差。",
    "一般來說，百貨公司的東西都比較貴，尤其是大牌子的商品。",
    "這家店不能刷卡，爸爸只好付現金。"
  ].join("\n"),
  "3": [
    "華人的重要節日，大部分都是根據農曆來的。",
    "除夕這一天，大家會一起祭祖然後吃年夜飯。",
    "端午節在農曆五月，天氣熱起來，蚊蟲也越來越多，所以大家會帶香包，門上會掛植物，希望可以趕走瘟疫。",
    "秋天是收成的季節，大家收成完後以後，剛好是中秋節，大家可以一起休息賞月吃月餅。",
    "台灣的天氣很潮濕，一定要買除濕機，不然東西都會發霉。",
    "台灣是個海島國家，天氣容易受到海風影響，很不穩定。",
    "台灣的冬天雖然溫度不高，但因為濕度比較高，所以實際感覺比較冷。"
  ].join("\n"),
  "4": [
    "昨天，大家一起去校外教學，參觀了臺北和平溪一帶的地方。安德思最喜歡平溪老街，那裡的氣氛讓他想起了家鄉。羅珊蒂也分享了自己元宵節去平溪放天燈的經驗。她的朋友帶她去寫願望、放天燈，雖然後來不小心跟朋友走散，手機也收不到訊號，但幸好遇到一位熱心的小姐，不但帶她回車站，還請她吃了一碗元宵，讓她非常感動。",
    "",
    "高橋健太說，臺灣人真的很有人情味。有一次他參觀臺南孔廟，正在研究牆上的字，一位老先生很有耐心地幫他解釋，讓他留下深刻的印象。大家也聊到臺灣有很多有特色的老店，尤其是藏在巷子裡的小吃店。這些店雖然沒有招牌，但只有當地人才知道，東西卻非常好吃。",
    "",
    "說到夜市，大家都很有共鳴。夜市裡的種類多、價錢便宜，熱鬧的氣氛讓人有過節的感覺。有人最愛臭豆腐，有人喜歡水煎包，也有人一定要吃炸雞排、配一杯冰紅茶。最後，大家決定找個週末一起去夜市，再好好感受臺灣的生活。"
  ].join("\n")
};

/** =======================
 *  Char -> Symbol mapping (minimal placeholder)
 *  ======================= */
const MAP = {
  "一": { zhuyin:"ㄧˋ", pinyin:"yì" },
  "爸": { zhuyin:"ㄅㄚˋ", pinyin:"bà" },
};

const PUNCS = new Set(["，","。","、","（","）","？","！","；","：","「","」","『","』","“","”","…","—"]);
function getSymbolForChar(ch, mode){
  if (ch === "\n") return "\n";
  if (ch === " ") return " ";
  if (PUNCS.has(ch)) return ch;

  const entry = MAP[ch];
  if (!entry) return "□";
  return entry[mode] ?? "□";
}

/** =======================
 *  Utils
 *  ======================= */
function escapeHtml(s){
  return String(s)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}
function splitLines(text){ return text.split("\n"); }
function tokeniseTarget(target){
  return splitLines(target).map(line => [...line]);
}
function formatTime(ms){
  const totalSec = Math.floor(ms/1000);
  const m = String(Math.floor(totalSec/60)).padStart(2,"0");
  const s = String(totalSec%60).padStart(2,"0");
  return `${m}:${s}`;
}

/**
 * 評估：以「文章出現內容」的行數與字位為基準（你要求的換行規則）
 * - 作答頁(1/3/5)：對的不變色；錯的紅
 * - 答案頁(2/4/6)：對綠錯紅 + 顯示字(正確符號)
 */
function evaluateByLineAndPosition(target, userRaw, mode){
  const tLines = tokeniseTarget(target);
  const uLines = splitLines(userRaw || "");

  const typingLines = [];
  const reviewLines = [];

  for (let li=0; li<tLines.length; li++){
    const tChars = tLines[li];
    const uLine = uLines[li] ?? "";
    const uChars = [...uLine];

    const tParts = [];
    const rParts = [];

    for (let ci=0; ci<tChars.length; ci++){
      const ch = tChars[ci];

      if (ch === " " || PUNCS.has(ch)){
        tParts.push(`<span class="char">${escapeHtml(ch)}</span>`);
        rParts.push(`<span class="char">${escapeHtml(ch)}</span>`);
        continue;
      }

      const typedCh = uChars[ci] ?? "";
      const ok = (typedCh === ch);

      // 作答頁：對的不變色；錯紅
      tParts.push(`<span class="char ${ok ? "" : "bad"}">${escapeHtml(ch)}</span>`);

      // 答案頁：對綠錯紅 + 顯示正確符號
      const sym = getSymbolForChar(ch, mode);
      rParts.push(`<span class="char ${ok ? "ok" : "bad"}">${escapeHtml(ch)}(${escapeHtml(sym)})</span>`);
    }

    typingLines.push(tParts.join(""));
    reviewLines.push(rParts.join(""));
  }

  return {
    typingHtml: typingLines.join("\n"),
    reviewHtml: reviewLines.join("\n")
  };
}

/** =======================
 *  UI refs
 *  ======================= */
const stageName = document.getElementById("stageName");
const articleBox = document.getElementById("articleBox");
const hint = document.getElementById("hint");
const inputBox = document.getElementById("inputBox");
const actionBtn = document.getElementById("actionBtn");
const fullscreenBtn = document.getElementById("fullscreenBtn");
const timerEl = document.getElementById("timer");
const fsCountEl = document.getElementById("fsCount");
const statsEl = document.getElementById("stats");
const finalTip = document.getElementById("finalTip");

const btnZhuyin = document.getElementById("btnZhuyin");
const btnPinyin = document.getElementById("btnPinyin");
const modeBadge = document.getElementById("modeBadge");

const lesson2Btn = document.getElementById("lesson2");
const lesson3Btn = document.getElementById("lesson3");
const lesson4Btn = document.getElementById("lesson4");

const startBtn = document.getElementById("startBtn");
const resetBtn = document.getElementById("resetBtn");
const customBtn = document.getElementById("customBtn");

/** =======================
 *  State
 *  ======================= */
let state = {
  mode: "zhuyin",
  lesson: "2",
  page: 0,
  target: "",
  input: "",
  lastEval: null,

  fsExitCount: 0,

  // timing per typing round
  timerRunning: false,
  roundStartMs: 0,
  roundElapsedMs: 0,
  roundTimes: { 1: 0, 2: 0, 3: 0 },

  // NEW: custom input content
  customDraft: defaultCustomDraft(),
  customLocked: ""
};

function defaultCustomDraft(){
  const lines = [];
  for (let i=1;i<=10;i++) lines.push(`${i}.`);
  return lines.join("\n");
}

function isTypingPage(p){ return p===1 || p===3 || p===5; }
function isReviewPage(p){ return p===2 || p===4 || p===6; }

// NEW: custom pages
// 7 = 自訂內容輸入頁（可編輯，禁複製貼上）
// 8 = 自訂內容確認頁（唯讀，答案不可更動）
// 然後按「開始」進入第 1 次作答（page=1）
function isCustomEditPage(p){ return p===7; }
function isCustomConfirmPage(p){ return p===8; }

function currentRoundIndex(){
  if (state.page===1 || state.page===2) return 1;
  if (state.page===3 || state.page===4) return 2;
  if (state.page===5 || state.page===6) return 3;
  return 1;
}

function loadTarget(){
  if (state.lesson === "custom") {
    state.target = state.customLocked || "";
  } else {
    state.target = LESSON_TEXT[state.lesson] || "";
  }
}

/** =======================
 *  Anti copy/paste (global typing box)
 *  ======================= */
document.addEventListener("copy", (e)=>e.preventDefault());
document.addEventListener("cut", (e)=>e.preventDefault());
inputBox.addEventListener("paste", (e)=>e.preventDefault());
inputBox.addEventListener("drop", (e)=>e.preventDefault());

/** =======================
 *  Fullscreen
 *  ======================= */
let fsReturnTimeout = null;
function requestFullscreen(){
  const el = document.documentElement;
  if (el.requestFullscreen) return el.requestFullscreen();
  if (el.webkitRequestFullscreen) return el.webkitRequestFullscreen();
  return Promise.resolve();
}
function exitFullscreen(){
  if (document.exitFullscreen) return document.exitFullscreen();
  if (document.webkitExitFullscreen) return document.webkitExitFullscreen();
  return Promise.resolve();
}
function isFullscreen(){
  return !!(document.fullscreenElement || document.webkitFullscreenElement);
}
function scheduleForceFullscreen(){
  if (!isTypingPage(state.page)) return;
  if (fsReturnTimeout) clearTimeout(fsReturnTimeout);
  fsReturnTimeout = setTimeout(()=>{ requestFullscreen().catch(()=>{}); }, 5000);
}
document.addEventListener("fullscreenchange", ()=>{
  if (!isTypingPage(state.page)) return;
  if (!isFullscreen()){
    state.fsExitCount += 1;
    fsCountEl.textContent = String(state.fsExitCount);
    scheduleForceFullscreen();
  }
});
fullscreenBtn.addEventListener("click", ()=> requestFullscreen().catch(()=>{}));

/** =======================
 *  Timer
 *  ======================= */
let timerTick = null;
function startRoundTimer(){
  state.timerRunning = true;
  state.roundStartMs = Date.now();
  state.roundElapsedMs = 0;
  timerEl.textContent = "00:00";

  if (timerTick) clearInterval(timerTick);
  timerTick = setInterval(()=>{
    if (!state.timerRunning) return;
    state.roundElapsedMs = Date.now() - state.roundStartMs;
    timerEl.textContent = formatTime(state.roundElapsedMs);
  }, 200);
}
function stopRoundTimer(){
  state.timerRunning = false;
  if (timerTick) clearInterval(timerTick);
  timerTick = null;

  const idx = currentRoundIndex();
  state.roundTimes[idx] = state.roundElapsedMs;
}

/** =======================
 *  Mode & Lesson UI
 *  ======================= */
function setMode(mode){
  state.mode = mode;
  btnZhuyin.classList.toggle("active", mode==="zhuyin");
  btnPinyin.classList.toggle("active", mode==="pinyin");
  modeBadge.textContent = `目前：${mode==="zhuyin" ? "注音" : "拼音"}`;
  render();
}
btnZhuyin.addEventListener("click", ()=>setMode("zhuyin"));
btnPinyin.addEventListener("click", ()=>setMode("pinyin"));

function setLesson(lesson){
  state.lesson = lesson;
  lesson2Btn.classList.toggle("active", lesson==="2");
  lesson3Btn.classList.toggle("active", lesson==="3");
  lesson4Btn.classList.toggle("active", lesson==="4");

  if (state.page === 0) {
    articleBox.textContent = "請先選擇「注音 / 拼音」與 Lesson，然後按「開始」。";
  }
  render();
}
lesson2Btn.addEventListener("click", ()=>setLesson("2"));
lesson3Btn.addEventListener("click", ()=>setLesson("3"));
lesson4Btn.addEventListener("click", ()=>setLesson("4"));

/** =======================
 *  NEW: custom flow
 *  ======================= */
function enterCustomEdit(){
  state.page = 7;
  // 保留 state.customDraft（可再進來繼續編）
  render();
}
function lockCustomAndConfirm(){
  // 鎖定內容後，不可再改
  state.customLocked = (state.customDraft || "").trimEnd();
  state.lesson = "custom"; // target will come from customLocked
  state.page = 8;
  render();
}
function startTypingFromCustom(){
  // 直接進入第 1 次作答
  enterTypingPage(1);
}

customBtn.addEventListener("click", ()=>{
  enterCustomEdit();
});

/** =======================
 *  Render helpers
 *  ======================= */
function setStageTitle(){
  const titles = {
    0: "尚未開始",
    1: "第 1 次作答（作答中）",
    2: "第 1 次答案公布",
    3: "第 2 次作答（作答中）",
    4: "第 2 次答案公布",
    5: "第 3 次作答（作答中）",
    6: "最終答案公布",
    7: "自訂內容（打字）",
    8: "自訂內容確認（不可更動）"
  };
  stageName.innerHTML = `<b>${titles[state.page] || "—"}</b>`;
}

function setActionButton(){
  if (state.page === 1){ actionBtn.disabled=false; actionBtn.textContent="第一次完成"; }
  else if (state.page === 2){ actionBtn.disabled=false; actionBtn.textContent="Second try"; }
  else if (state.page === 3){ actionBtn.disabled=false; actionBtn.textContent="第二次完成"; }
  else if (state.page === 4){ actionBtn.disabled=false; actionBtn.textContent="Third try"; }
  else if (state.page === 5){ actionBtn.disabled=false; actionBtn.textContent="最後一次完成"; }
  else if (state.page === 7){ actionBtn.disabled=false; actionBtn.textContent="完成（鎖定內容）"; }
  else if (state.page === 8){ actionBtn.disabled=false; actionBtn.textContent="開始（第 1 次作答）"; }
  else { actionBtn.disabled=true; actionBtn.textContent="開始"; }
}

function setHintText(){
  if (isTypingPage(state.page)){
    hint.textContent = "作答頁：對的不變色、錯字紅。請依文章換行對齊輸入（可換行）。";
  } else if (isReviewPage(state.page)){
    hint.textContent = "答案頁：對綠錯紅，並顯示字(正確注音/拼音)。";
  } else if (isCustomEditPage(state.page)){
    hint.textContent = "請在下方輸入自訂內容（預設 1.–10.）。此框不可複製/貼上/剪下。按完成後進入下一頁，內容會鎖定不可更動。";
  } else if (isCustomConfirmPage(state.page)){
    hint.textContent = "內容已鎖定（不可更動）。按下開始會進入原本的打字練習流程。";
  } else {
    hint.textContent = "";
  }
}

function applyInputEnabled(enabled, placeholder){
  inputBox.disabled = !enabled;
  inputBox.placeholder = placeholder || (enabled ? "請在此輸入（可換行）" : "（此頁不需輸入）");
  if (!enabled) inputBox.value = "";
}

function applyFullscreenPolicy(){
  if (isTypingPage(state.page)){
    fullscreenBtn.style.display="";
    requestFullscreen().catch(()=>{});
    scheduleForceFullscreen();
  } else {
    fullscreenBtn.style.display="none";
  }
}

function renderStats(){
  if (isReviewPage(state.page)){
    const idx = currentRoundIndex();
    const timeMs = state.roundTimes[idx] || 0;
    statsEl.innerHTML = `
      <div>本輪打字時間：<strong class="mono">${formatTime(timeMs)}</strong></div>
      <div>本輪跳出全螢幕次數：<strong class="mono">${state.fsExitCount}</strong></div>
    `;
  } else {
    statsEl.textContent = "";
  }
}

function render(){
  setStageTitle();
  setActionButton();
  setHintText();
  fsCountEl.textContent = String(state.fsExitCount);

  finalTip.style.display = (state.page===6) ? "" : "none";

  // custom edit page
  if (state.page === 7){
    // 題目框此頁變成「說明區」即可
    articleBox.classList.remove("noSelect");
    articleBox.textContent = "請在下方輸入自訂內容（打字框內不可複製/貼上/剪下）。完成後將鎖定內容。";

    applyInputEnabled(true, "請輸入自訂內容…（不可複製/貼上/剪下）");
    inputBox.value = state.customDraft || defaultCustomDraft();

    // 專屬：禁止 copy/cut/paste（只針對這個自訂框）
    inputBox.oncopy = (e)=>e.preventDefault();
    inputBox.oncut = (e)=>e.preventDefault();
    inputBox.onpaste = (e)=>e.preventDefault();

    // 不要全螢幕、不要計時
    if (timerTick) clearInterval(timerTick);
    timerTick = null;
    timerEl.textContent = "00:00";
    fullscreenBtn.style.display="none";
    statsEl.textContent = "";
    return;
  }

  // custom confirm page
  if (state.page === 8){
    articleBox.classList.add("noSelect");
    articleBox.textContent = state.customLocked || "";
    applyInputEnabled(false);
    inputBox.oncopy = null; inputBox.oncut = null; inputBox.onpaste = null;

    if (timerTick) clearInterval(timerTick);
    timerTick = null;
    timerEl.textContent = "00:00";
    fullscreenBtn.style.display="none";
    statsEl.textContent = "";
    return;
  }

  // default start
  if (state.page===0){
    articleBox.classList.add("noSelect");
    applyInputEnabled(false);
    timerEl.textContent = "00:00";
    statsEl.textContent = "";
    articleBox.textContent = "請先選擇「注音 / 拼音」與 Lesson，然後按「開始」。";
    inputBox.oncopy = null; inputBox.oncut = null; inputBox.onpaste = null;
    return;
  }

  // regular pages
  inputBox.oncopy = null; inputBox.oncut = null; inputBox.onpaste = (e)=>e.preventDefault();

  loadTarget();

  if (isTypingPage(state.page)){
    articleBox.classList.add("noSelect");
    applyInputEnabled(true, "請在此輸入（可換行）");
    if (!state.input){
      articleBox.textContent = state.target;
      inputBox.value = "";
    } else {
      inputBox.value = state.input;
      const ev = evaluateByLineAndPosition(state.target, state.input, state.mode);
      articleBox.innerHTML = ev.typingHtml;
    }
    applyFullscreenPolicy();
  }

  if (isReviewPage(state.page)){
    articleBox.classList.add("noSelect");
    applyInputEnabled(false);
    applyFullscreenPolicy();
    if (state.lastEval){
      articleBox.innerHTML = state.lastEval.reviewHtml;
    } else {
      articleBox.textContent = state.target;
    }
  }

  renderStats();
}

/** =======================
 *  Input handling (typing pages + custom edit)
 *  ======================= */
inputBox.addEventListener("input", ()=>{
  if (isCustomEditPage(state.page)){
    state.customDraft = inputBox.value;
    return;
  }
  if (!isTypingPage(state.page)) return;

  state.input = inputBox.value;
  const ev = evaluateByLineAndPosition(state.target, state.input, state.mode);
  articleBox.innerHTML = ev.typingHtml;
});

/** =======================
 *  Flow control
 *  ======================= */
function resetAll(){
  state.page = 0;
  state.input = "";
  state.lastEval = null;
  state.fsExitCount = 0;
  state.timerRunning = false;
  state.roundStartMs = 0;
  state.roundElapsedMs = 0;
  state.roundTimes = {1:0,2:0,3:0};
  if (timerTick) clearInterval(timerTick);
  timerTick = null;

  // custom keep draft but unlock content (讓你下次可以重新輸入)
  state.customLocked = "";
  if (!state.customDraft) state.customDraft = defaultCustomDraft();

  exitFullscreen().catch(()=>{});
  render();
}

function enterTypingPage(page){
  state.page = page;
  state.input = "";
  state.lastEval = null;
  state.fsExitCount = 0;
  fsCountEl.textContent = "0";
  startRoundTimer();
  render();
}

startBtn.addEventListener("click", ()=>{
  // 如果已經在 custom confirm 且 lesson=custom，按開始一樣會進 typing
  enterTypingPage(1);
});

resetBtn.addEventListener("click", ()=>{
  resetAll();
});

actionBtn.addEventListener("click", ()=>{
  // custom flow
  if (state.page===7){
    lockCustomAndConfirm();
    return;
  }
  if (state.page===8){
    startTypingFromCustom();
    return;
  }

  // normal flow
  if (state.page===1){
    stopRoundTimer();
    state.lastEval = evaluateByLineAndPosition(state.target, state.input, state.mode);
    exitFullscreen().catch(()=>{});
    state.page = 2;
    render();
    return;
  }
  if (state.page===2){
    enterTypingPage(3);
    return;
  }
  if (state.page===3){
    stopRoundTimer();
    state.lastEval = evaluateByLineAndPosition(state.target, state.input, state.mode);
    exitFullscreen().catch(()=>{});
    state.page = 4;
    render();
    return;
  }
  if (state.page===4){
    enterTypingPage(5);
    return;
  }
  if (state.page===5){
    stopRoundTimer();
    state.lastEval = evaluateByLineAndPosition(state.target, state.input, state.mode);
    exitFullscreen().catch(()=>{});
    state.page = 6;
    render();
    return;
  }
});

(function init(){
  loadTarget();
  render();
})();
</script>
</body>
</html>
